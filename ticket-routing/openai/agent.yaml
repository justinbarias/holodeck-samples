# Ticket Routing Agent - OpenAI Variant
# Classifies and routes customer support tickets to appropriate departments

name: ticket-routing
description: AI-powered ticket classification and routing system

model:
  provider: openai
  name: gpt-4o
  temperature: 0.1  # Low temperature for consistent classification
  max_tokens: 1000

response_format:
  type: object
  properties:
    category:
      type: string
      enum: [billing, technical, sales, account, general]
      description: The category of the support ticket
    urgency:
      type: string
      enum: [critical, high, medium, low]
      description: How urgently the ticket needs attention
    routing_department:
      type: string
      description: The department that should handle this ticket
    confidence_score:
      type: number
      minimum: 0
      maximum: 1
      description: Confidence level in the classification (0.0-1.0)
    reasoning:
      type: string
      description: Brief explanation of the classification decision
  required:
    - category
    - urgency
    - routing_department
    - confidence_score
    - reasoning
  additionalProperties: false

instructions:
  file: instructions/system-prompt.md

tools:
  - type: vectorstore
    name: ticket_categories
    description: Search ticket category definitions and routing rules
    source: data/ticket_categories.json
    embedding_model: text-embedding-3-small
    database: chromadb
    top_k: 3
    chunk_size: 512
    chunk_overlap: 64
    min_similarity_score: 0.6
    id_field: id
    vector_field: content
    meta_fields:
      - name
      - routing_department
      - sla_hours
      - keywords

evaluations:
  model:
    provider: openai
    name: gpt-4o
    temperature: 0.0
  metrics:
    - type: geval
      name: ClassificationAccuracy
      criteria: |
        Evaluate if the ticket was correctly classified into the appropriate category.
        Consider whether the category matches the ticket content and issue type.
        A correct classification should:
        1. Match the primary issue described in the ticket
        2. Consider all keywords and context clues
        3. Not be confused by secondary or tangential issues
      evaluation_steps:
        - Identify the main issue in the ticket
        - Check if the assigned category matches the issue type
        - Verify the category aligns with standard support categorization
      evaluation_params:
        - actual_output
        - expected_output
      threshold: 0.8

    - type: geval
      name: UrgencyAssessment
      criteria: |
        Evaluate if the urgency level appropriately reflects the ticket's priority.
        Consider business impact, customer language, and issue severity.
        Critical should be reserved for outages, security issues, and data loss.
        High for account access issues and production blockers.
        Medium for general bugs and standard requests.
        Low for information requests and non-urgent feedback.
      evaluation_steps:
        - Analyze the customer's language for urgency indicators
        - Assess the potential business impact
        - Verify urgency matches standard escalation guidelines
      evaluation_params:
        - actual_output
        - expected_output
      threshold: 0.75

    - type: geval
      name: ReasoningQuality
      criteria: |
        Evaluate if the reasoning provided is clear, logical, and supports the classification.
        Good reasoning should:
        1. Reference specific elements from the ticket
        2. Explain why the category was chosen
        3. Justify the urgency level
        4. Be concise but complete
      evaluation_params:
        - actual_output
      threshold: 0.7

    - type: rag
      metric_type: faithfulness
      threshold: 0.7

test_cases:
  - name: Billing - High urgency double charge
    input: "I was charged twice for my subscription last month. Order #12345. Please refund immediately."
    ground_truth: '{"category": "billing", "urgency": "high"}'
    expected_tools:
      - ticket_categories

  - name: Technical - Critical API outage
    input: "Our production system is getting 500 errors from your API. Authentication endpoint is completely down. This is blocking our entire business."
    ground_truth: '{"category": "technical", "urgency": "critical"}'
    expected_tools:
      - ticket_categories

  - name: Sales - Enterprise inquiry
    input: "We're evaluating your platform for our 500+ employee company. Can we schedule a demo and discuss enterprise pricing?"
    ground_truth: '{"category": "sales", "urgency": "high"}'
    expected_tools:
      - ticket_categories

  - name: Account - Locked out
    input: "I've tried resetting my password 5 times but never receive the email. I'm locked out and have an important presentation tomorrow."
    ground_truth: '{"category": "account", "urgency": "high"}'
    expected_tools:
      - ticket_categories

  - name: General - Low priority question
    input: "What are your business hours? Do you have phone support available?"
    ground_truth: '{"category": "general", "urgency": "low"}'
    expected_tools:
      - ticket_categories

observability:
  enabled: true
  service_name: holodeck-ticket-routing
  traces:
    enabled: true
    sample_rate: 1.0
    capture_content: false
  metrics:
    enabled: true
    export_interval_ms: 5000
  logs:
    enabled: true
    level: INFO
  exporters:
    otlp:
      enabled: true
      endpoint: http://localhost:4317
      protocol: grpc
      insecure: true
